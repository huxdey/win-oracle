<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIN ORACLE - Intelig√™ncia de Mercado</title>
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonte Inter e JetBrains Mono para dados -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        oracle: {
                            bg: '#020408',      /* Fundo ultra escuro */
                            card: '#0B101B',    /* Fundo dos cards */
                            border: '#1E293B',  /* Bordas sutis */
                            accent: '#3B82F6',  /* Azul Oracle */
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Styles */
        body {
            background-color: #020408;
            color: #e2e8f0;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(59, 130, 246, 0.08), transparent 25%), 
                radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.08), transparent 25%);
            background-attachment: fixed;
        }

        /* Glassmorphism Cards */
        .glass-panel {
            background: rgba(11, 16, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-top: 1px solid rgba(255, 255, 255, 0.1); /* Highlight top */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            border-radius: 1rem;
            transition: all 0.3s ease;
        }

        /* Input Styles */
        .oracle-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #1E293B;
            transition: all 0.3s ease;
            color: white;
        }
        .oracle-input:focus {
            background: rgba(15, 23, 42, 0.9);
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Button Styles */
        .btn-oracle {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn-oracle:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.4);
            filter: brightness(1.1);
        }
        .btn-oracle::after { /* Shine effect */
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent);
            transform: skewX(-20deg);
            transition: 0.5s;
        }
        .btn-oracle:hover::after {
            left: 200%;
        }

        /* Result Cards */
        .result-card {
            background: rgba(17, 24, 39, 0.7);
            border: 1px solid rgba(30, 41, 59, 0.8);
            border-radius: 0.75rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .result-card:hover {
            transform: translateY(-4px);
            border-color: #3B82F6;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 0 15px rgba(59, 130, 246, 0.15);
            background: rgba(22, 30, 46, 0.9);
        }

        /* Typography Gradients */
        .text-gradient {
            background: linear-gradient(to right, #60A5FA, #A78BFA);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #020408; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6 lg:p-12 font-sans selection:bg-blue-500/30 selection:text-blue-200">

    <!-- Header Principal -->
    <header class="max-w-7xl mx-auto mb-12 text-center relative">
        <div class="inline-flex items-center justify-center px-3 py-1 mb-4 rounded-full border border-blue-500/20 bg-blue-500/5 backdrop-blur-sm">
            <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse mr-2"></span>
            <span class="text-xs font-mono text-blue-400 uppercase tracking-widest">System v2.2 Online</span>
        </div>
        
        <!-- NOVO ELEMENTO: SELETOR DE IDIOMA -->
        <div class="absolute right-0 top-0 hidden md:block">
            <select id="languageSelector" onchange="setLanguage(this.value)"
                class="glass-panel text-sm font-mono p-2 rounded-lg cursor-pointer bg-oracle-card/70 border-oracle-border/50 focus:border-oracle-accent focus:ring-0 text-white">
                <option value="en">üá∫üá∏ English</option>
                <option value="pt">üáßüá∑ Portugu√™s</option>
                <option value="es">üá™üá∏ Espa√±ol</option>
            </select>
        </div>
        
        <h1 class="text-6xl md:text-7xl font-black tracking-tight mb-2">
            WIN <span class="text-gradient">ORACLE</span>
        </h1>
        <p class="text-slate-400 text-lg md:text-xl font-light tracking-wide max-w-2xl mx-auto">
            O motor de intelig√™ncia definitivo para prospec√ß√£o de mercado.
        </p>
    </header>

    <!-- √Årea de Busca -->
    <main class="max-w-5xl mx-auto relative z-10">
        <div class="glass-panel p-8 mb-8">
            <form id="searchForm" class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <label class="block text-xs font-mono text-slate-500 mb-1 ml-1">TERMO DE BUSCA</label>
                    <input type="text" id="query" placeholder="Ex: Escrit√≥rio de Advocacia, Pizzaria..." required
                            class="oracle-input w-full p-4 rounded-lg focus:outline-none placeholder-slate-600 font-medium">
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-mono text-slate-500 mb-1 ml-1">LOCALIZA√á√ÉO ALVO</label>
                    <input type="text" id="location" placeholder="Ex: Jardins SP, Copacabana..." required
                            class="oracle-input w-full p-4 rounded-lg focus:outline-none placeholder-slate-600 font-medium">
                </div>
                <div class="flex flex-col justify-end">
                    <button type="submit" id="searchButton"
                            class="btn-oracle h-[58px] px-8 rounded-lg font-bold tracking-wider text-white uppercase flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        Escanear
                    </button>
                </div>
            </form>

            <!-- Barra de Ferramentas / Filtros -->
            <div class="mt-6 pt-6 border-t border-slate-800 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <button id="clearButton" onclick="clearSearch()" class="text-slate-500 hover:text-red-400 text-sm font-medium transition-colors flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        Limpar Dados
                    </button>
                    <span class="text-slate-700">|</span>
                    <span id="statusMessage" class="text-blue-400/80 font-mono text-sm animate-pulse-slow">Aguardando comando...</span>
                </div>
                
                <div class="flex gap-2">
                    <button id="exportWithSiteButton" onclick="exportToCSV('with_site')" disabled
                            class="hidden opacity-50 px-4 py-2 rounded-lg bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-xs font-bold hover:bg-emerald-500/20 transition-all uppercase tracking-wider">
                        CSV (Com Site)
                    </button>
                    <button id="exportWithoutSiteButton" onclick="exportToCSV('without_site')" disabled
                            class="hidden opacity-50 px-4 py-2 rounded-lg bg-amber-500/10 border border-amber-500/20 text-amber-400 text-xs font-bold hover:bg-amber-500/20 transition-all uppercase tracking-wider">
                        CSV (Sem Site)
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard de M√©tricas (aparece ap√≥s busca) -->
        <div id="metricsDashboard" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="glass-panel p-4 flex flex-col items-center justify-center border-l-4 border-l-blue-500">
                <span class="text-slate-400 text-xs font-mono uppercase">Total Encontrado</span>
                <span id="totalResultsDisplay" class="text-3xl font-bold text-white mt-1">0</span>
            </div>
            <div class="glass-panel p-4 flex flex-col items-center justify-center border-l-4 border-l-emerald-500">
                <span class="text-slate-400 text-xs font-mono uppercase">Com Site (V√°lidos)</span>
                <span id="counterWithSite" class="text-3xl font-bold text-emerald-400 mt-1">0</span>
            </div>
            <div class="glass-panel p-4 flex flex-col items-center justify-center border-l-4 border-l-red-500">
                <span class="text-slate-400 text-xs font-mono uppercase">Sem Site (Alvos)</span>
                <span id="counterWithoutSite" class="text-3xl font-bold text-red-400 mt-1">0</span>
            </div>
            <div class="glass-panel p-4 flex flex-col items-center justify-center border-l-4 border-l-purple-500">
                <span class="text-slate-400 text-xs font-mono uppercase">Conclus√£o Satisfat√≥ria</span>
                <span id="satisfactoryRateDisplay" class="text-3xl font-bold text-purple-400 mt-1">0%</span>
            </div>
        </div>

        <!-- Resultados -->
        <div id="resultsTitleWrapper" class="hidden mb-6 flex items-end justify-between border-b border-slate-800 pb-2">
            <h2 class="text-xl font-bold text-white tracking-wide">
                <span class="text-blue-500 mr-2">///</span> ENTIDADES DETECTADAS (MAX 50)
            </h2>
            <span class="text-xs text-slate-500 font-mono">LIVE FEED</span>
        </div>

        <div id="results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
            <!-- Cards ser√£o injetados aqui -->
        </div>

    </main>

    <!-- Footer -->
    <footer class="fixed bottom-0 left-0 w-full py-2 bg-[#020408]/90 backdrop-blur border-t border-slate-800 text-center z-40">
        <p class="text-[10px] text-slate-600 font-mono">
            WIN ORACLE SYSTEM ‚Ä¢ POWERED BY GOOGLE PLACES API ‚Ä¢ SECURE CONNECTION
        </p>
    </footer>

    <!-- Scripts -->
    <!-- A chave da API √© fict√≠cia; o ambiente Canvas fornece a chave real em tempo de execu√ß√£o. -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAI6632c5sM0SACWKlQ9Y-kd1IL2tdBKFY&libraries=places&callback=initMap"></script>
    
    <script>
        let map, service;
        let allSearchResults = [], resultsWithWebsite = [], resultsWithoutWebsite = [];
        
        // Elementos UI
        const resultsDiv = document.getElementById('results');
        const resultsTitleWrapper = document.getElementById('resultsTitleWrapper');
        const metricsDashboard = document.getElementById('metricsDashboard');
        const statusMessage = document.getElementById('statusMessage');
        const searchButton = document.getElementById('searchButton');

        // Contadores
        const totalResultsDisplay = document.getElementById('totalResultsDisplay');
        const counterWithSite = document.getElementById('counterWithSite');
        const counterWithoutSite = document.getElementById('counterWithoutSite');
        const satisfactoryRateDisplay = document.getElementById('satisfactoryRateDisplay');

        // Bot√µes de A√ß√£o
        const exportWithSiteBtn = document.getElementById('exportWithSiteButton');
        const exportWithoutSiteBtn = document.getElementById('exportWithoutSiteButton');

        // --- Novo Dicion√°rio de Tradu√ß√µes ---
        const translations = {
            'en': {
                title: 'WIN ORACLE',
                subtitle: 'The definitive intelligence engine for market prospecting.',
                statusOnline: 'System v2.2 Online',
                labelQuery: 'SEARCH TERM',
                placeholderQuery: 'Ex: Law Firm, Pizzeria...',
                labelLocation: 'TARGET LOCATION',
                placeholderLocation: 'Ex: Gardens SP, Copacabana...',
                buttonScan: 'Scan',
                buttonClear: 'Clear Data',
                statusWaiting: 'Awaiting command...',
                statusScanning: (q, l) => `Scanning: ${q} in ${l}...`,
                statusAnalysing: (n) => `Analysed: ${n} entities...`,
                statusExtracting: 'Entities processed. Extracting full details...',
                statusSuccess: 'Processing concluded successfully.',
                statusNoResults: 'No results found.',
                metricTotal: 'Total Found',
                metricWithSite: 'With Website (Valid)',
                metricWithoutSite: 'Without Website (Targets)',
                metricRate: 'Satisfactory Conclusion',
                resultsTitle: 'DETECTED ENTITIES (MAX 50)',
                liveFeed: 'LIVE FEED',
                maps: 'Maps',
                visitSite: 'Visit Site',
                noSite: 'No Website',
                target: 'TARGET',
                addressNotAvailable: 'Address not available',
                phoneNotAvailable: 'No phone',
                exportWithSite: 'CSV (With Site)',
                exportWithoutSite: 'CSV (Without Site)',
                footer: 'WIN ORACLE SYSTEM ‚Ä¢ POWERED BY GOOGLE PLACES API ‚Ä¢ SECURE CONNECTION',
            },
            'pt': {
                title: 'WIN ORACLE',
                subtitle: 'O motor de intelig√™ncia definitivo para prospec√ß√£o de mercado.',
                statusOnline: 'System v2.2 Online',
                labelQuery: 'TERMO DE BUSCA',
                placeholderQuery: 'Ex: Escrit√≥rio de Advocacia, Pizzaria...',
                labelLocation: 'LOCALIZA√á√ÉO ALVO',
                placeholderLocation: 'Ex: Jardins SP, Copacabana...',
                buttonScan: 'Escanear',
                buttonClear: 'Limpar Dados',
                statusWaiting: 'Aguardando comando...',
                statusScanning: (q, l) => `Escaneando: ${q} em ${l}...`,
                statusAnalysing: (n) => `Analisados: ${n} entidades...`,
                statusExtracting: 'Entidades processadas. Extraindo detalhes completos...',
                statusSuccess: 'Processamento conclu√≠do com sucesso.',
                statusNoResults: 'Nenhum resultado encontrado.',
                metricTotal: 'Total Encontrado',
                metricWithSite: 'Com Site (V√°lidos)',
                metricWithoutSite: 'Sem Site (Alvos)',
                metricRate: 'Conclus√£o Satisfat√≥ria',
                resultsTitle: 'ENTIDADES DETECTADAS (MAX 50)',
                liveFeed: 'LIVE FEED',
                maps: 'Maps',
                visitSite: 'Visitar Site',
                noSite: 'Sem Site',
                target: 'ALVO',
                addressNotAvailable: 'Endere√ßo n√£o dispon√≠vel',
                phoneNotAvailable: 'Sem telefone',
                exportWithSite: 'CSV (Com Site)',
                exportWithoutSite: 'CSV (Sem Site)',
                footer: 'WIN ORACLE SYSTEM ‚Ä¢ POWERED BY GOOGLE PLACES API ‚Ä¢ SECURE CONNECTION',
            },
            'es': {
                title: 'WIN ORACLE',
                subtitle: 'El motor de inteligencia definitivo para la prospecci√≥n de mercado.',
                statusOnline: 'System v2.2 Online',
                labelQuery: 'T√âRMINO DE B√öSQUEDA',
                placeholderQuery: 'Ej: Despacho de Abogados, Pizzer√≠a...',
                labelLocation: 'UBICACI√ìN OBJETIVO',
                placeholderLocation: 'Ej: Jardines SP, Copacabana...',
                buttonScan: 'Escanear',
                buttonClear: 'Borrar Datos',
                statusWaiting: 'Esperando comando...',
                statusScanning: (q, l) => `Escaneando: ${q} en ${l}...`,
                statusAnalysing: (n) => `Analizadas: ${n} entidades...`,
                statusExtracting: 'Entidades procesadas. Extrayendo detalles completos...',
                statusSuccess: 'Procesamiento concluido con √©xito.',
                statusNoResults: 'No se encontraron resultados.',
                metricTotal: 'Total Encontrado',
                metricWithSite: 'Con Sitio Web (V√°lidos)',
                metricWithoutSite: 'Sin Sitio Web (Objetivos)',
                metricRate: 'Conclusi√≥n Satisfactoria',
                resultsTitle: 'ENTIDADES DETECTADAS (M√ÅX 50)',
                liveFeed: 'LIVE FEED',
                maps: 'Maps',
                visitSite: 'Visitar Sitio',
                noSite: 'Sin Sitio',
                target: 'OBJETIVO',
                addressNotAvailable: 'Direcci√≥n no disponible',
                phoneNotAvailable: 'Sin tel√©fono',
                exportWithSite: 'CSV (Con Sitio)',
                exportWithoutSite: 'CSV (Sin Sitio)',
                footer: 'WIN ORACLE SYSTEM ‚Ä¢ POWERED BY GOOGLE PLACES API ‚Ä¢ SECURE CONNECTION',
            },
        };

        let currentLanguage = 'en'; // Definido para 'en' na inicializa√ß√£o

        function initMap() {
            const mapElement = document.createElement('div');
            map = new google.maps.Map(mapElement, { center: { lat: 0, lng: 0 }, zoom: 1 });
            service = new google.maps.places.PlacesService(map);
            setStatus("Initialized", "text-emerald-400"); // Inicializa com a tradu√ß√£o do status
        }

        // Fun√ß√£o de tradu√ß√£o
        function setLanguage(lang) {
            currentLanguage = lang;
            const t = translations[lang];

            // Header
            document.querySelector('h1').innerHTML = `WIN <span class="text-gradient">${t.title.split(' ')[1]}</span>`;
            document.querySelector('header p').textContent = t.subtitle;
            document.querySelector('.inline-flex span:last-child').textContent = t.statusOnline;

            // Search Form
            document.querySelector('#query').previousElementSibling.textContent = t.labelQuery;
            document.querySelector('#query').placeholder = t.placeholderQuery;
            document.querySelector('#location').previousElementSibling.textContent = t.labelLocation;
            document.querySelector('#location').placeholder = t.placeholderLocation;
            document.querySelector('#searchButton').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg> ${t.buttonScan}`;
            document.querySelector('#clearButton').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg> ${t.buttonClear}`;

            // Action Buttons
            exportWithSiteBtn.textContent = t.exportWithSite;
            exportWithoutSiteBtn.textContent = t.exportWithoutSite;
            
            // Metrics Dashboard (Labels)
            document.querySelector('#metricsDashboard > div:nth-child(1) span:first-child').textContent = t.metricTotal;
            document.querySelector('#metricsDashboard > div:nth-child(2) span:first-child').textContent = t.metricWithSite;
            document.querySelector('#metricsDashboard > div:nth-child(3) span:first-child').textContent = t.metricWithoutSite;
            document.querySelector('#metricsDashboard > div:nth-child(4) span:first-child').textContent = t.metricRate;

            // Results Header
            document.querySelector('#resultsTitleWrapper h2').innerHTML = `<span class="text-blue-500 mr-2">///</span> ${t.resultsTitle}`;
            document.querySelector('#resultsTitleWrapper span:last-child').textContent = t.liveFeed;
            
            // Footer
            document.querySelector('footer p').textContent = t.footer;
            
            // Re-renderizar resultados ou atualizar status
            if (allSearchResults.length > 0) {
                renderResults(allSearchResults);
            } else {
                setStatus("Waiting"); // Atualiza status inicial
            }
        }

        // Fun√ß√£o setStatus ajustada para usar chaves de tradu√ß√£o
        function setStatus(statusKey, colorClass = "text-blue-400") {
            const t = translations[currentLanguage];
            let msg;
            let animate = false;

            switch (statusKey) {
                case "Initialized":
                    msg = `${t.statusOnline.split(' ').slice(0, 2).join(' ')}. ${t.statusSuccess.split('.').pop().trim()}`; // Simplificado para "System Online. Ready."
                    colorClass = "text-emerald-400";
                    break;
                case "Waiting":
                    msg = t.statusWaiting;
                    colorClass = "text-slate-400";
                    break;
                case "Cleared":
                    msg = `${t.buttonClear.split(' ').join(' ')}. ${t.statusWaiting}`; // "Data cleared. Awaiting command..."
                    colorClass = "text-slate-400";
                    break;
                case "NoResults":
                    msg = t.statusNoResults;
                    colorClass = "text-slate-500";
                    break;
                case "Scanning":
                    const query = document.getElementById('query').value;
                    const location = document.getElementById('location').value;
                    msg = t.statusScanning(query, location);
                    colorClass = "text-amber-400";
                    animate = true;
                    break;
                case "Analyzing":
                    const n = allSearchResults.length || 0;
                    msg = t.statusAnalysing(n);
                    colorClass = "text-amber-400";
                    animate = true;
                    break;
                case "Extracting":
                    msg = t.statusExtracting;
                    colorClass = "text-blue-400";
                    break;
                case "Finished":
                    msg = t.statusSuccess;
                    colorClass = "text-emerald-400";
                    break;
                default:
                    msg = statusKey; // Mensagem literal
                    colorClass = "text-blue-400";
            }

            statusMessage.textContent = msg;
            statusMessage.className = `font-mono text-sm ${colorClass} ${animate ? 'animate-pulse' : ''}`;
        }

        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const query = document.getElementById('query').value;
            const location = document.getElementById('location').value;
            
            if (service) {
                performSearch(query, location);
            } else {
                setStatus("Error: Google Maps API failed to load.", "text-red-500");
            }
        });

        function clearSearch() {
            document.getElementById('query').value = '';
            document.getElementById('location').value = '';
            resultsDiv.innerHTML = '';
            metricsDashboard.classList.add('hidden');
            resultsTitleWrapper.classList.add('hidden');
            
            // Reset Arrays
            allSearchResults = []; resultsWithWebsite = []; resultsWithoutWebsite = [];
            
            // Reset Buttons
            toggleActionButtons(false, false);
            setStatus("Cleared");
            searchButton.disabled = false;
            
            // Reset button text using translation
            const t = translations[currentLanguage];
            searchButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg> ${t.buttonScan}`;
        }

        function performSearch(query, location) {
            resultsDiv.innerHTML = '';
            allSearchResults = [];
            
            let accumulatedResults = [];

            setStatus("Scanning");
            searchButton.disabled = true;
            searchButton.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...`;
            
            const request = { query: `${query} in ${location}` }; // Usando ingl√™s para a API para consist√™ncia

            // Fun√ß√£o de callback para textSearch (inclui pagina√ß√£o)
            const searchCallback = (results, status, pagination) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    
                    accumulatedResults = [...accumulatedResults, ...results];
                    
                    setStatus("Analyzing");

                    if (pagination && pagination.hasNextPage && accumulatedResults.length < 50) {
                        setTimeout(() => {
                            pagination.nextPage();
                        }, 2000); // 2 segundos de pausa obrigat√≥ria da API
                    } else {
                        // Chegamos ao fim ou ao limite
                        finishSearch(accumulatedResults);
                    }
                } else {
                    if (accumulatedResults.length === 0) {
                        setStatus("NoResults");
                        searchButton.disabled = false;
                        const t = translations[currentLanguage];
                        searchButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg> ${t.buttonScan}`;
                    } else {
                        // Se der erro no meio, processa o que temos
                        finishSearch(accumulatedResults);
                    }
                }
            };

            service.textSearch(request, searchCallback);
        }

        function finishSearch(rawResults) {
            const finalResults = rawResults.slice(0, 50);
            
            setStatus("Extracting");
            processSearchResults(finalResults);
        }

        function processSearchResults(results) {
            // Processa TODOS os resultados recebidos (at√© 50)
            let promises = results.map(place => {
                return new Promise((resolve) => {
                    service.getDetails({
                        placeId: place.place_id,
                        fields: ['name', 'formatted_address', 'formatted_phone_number', 'website', 'rating', 'url', 'user_ratings_total']
                    }, (details, status) => {
                        // Se falhar o detalhe (rate limit), usa o objeto b√°sico 'place'
                        resolve(status === google.maps.places.PlacesServiceStatus.OK ? details : place);
                    });
                });
            });

            Promise.all(promises).then(detailedResults => {
                allSearchResults = detailedResults;
                resultsWithWebsite = allSearchResults.filter(p => p.website && p.website.length > 5);
                resultsWithoutWebsite = allSearchResults.filter(p => !p.website || p.website.length < 5);

                renderResults(allSearchResults);
                updateMetrics();
                
                searchButton.disabled = false;
                const t = translations[currentLanguage];
                searchButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg> ${t.buttonScan}`;
                setStatus("Finished");
            });
        }

        function updateMetrics() {
            const total = allSearchResults.length;
            const withSite = resultsWithWebsite.length;
            const withoutSite = resultsWithoutWebsite.length;
            
            // C√ÅLCULO DE CONCLUS√ÉO SATISFAT√ìRIA (Baseado em quem TEM site)
            const satisfactoryRate = total > 0 ? ((withSite / total) * 100).toFixed(0) : 0;

            // Show Dashboards
            metricsDashboard.classList.remove('hidden');
            resultsTitleWrapper.classList.remove('hidden');

            // Animate Numbers
            totalResultsDisplay.textContent = total;
            counterWithSite.textContent = withSite;
            counterWithoutSite.textContent = withoutSite;
            satisfactoryRateDisplay.textContent = `${satisfactoryRate}%`;

            // Enable Buttons
            const hasData = total > 0;
            toggleActionButtons(hasData);
        }

        function toggleActionButtons(hasData) {
            const toggle = (btn, condition) => {
                if(condition) {
                    btn.classList.remove('hidden');
                    btn.classList.remove('opacity-50');
                    btn.disabled = false;
                } else {
                    btn.classList.add('opacity-50');
                    btn.disabled = true;
                    if(!hasData) btn.classList.add('hidden'); 
                }
            };

            toggle(exportWithSiteBtn, resultsWithWebsite.length > 0);
            toggle(exportWithoutSiteBtn, resultsWithoutWebsite.length > 0);
        }

        // Fun√ß√£o renderResults atualizada para usar a tradu√ß√£o correta dos cards
        function renderResults(results) {
            const t = translations[currentLanguage];
            resultsDiv.innerHTML = '';
            results.forEach((place, index) => {
                const hasSite = place.website && place.website.length > 5;
                const delay = index * 50; 
                
                const card = document.createElement('div');
                card.className = `result-card p-5 relative overflow-hidden opacity-0 animate-fade-in-up`;
                card.style.animation = `fadeInUp 0.5s ease forwards ${delay}ms`;
                
                const statusColor = hasSite ? 'bg-emerald-500' : 'bg-red-500';
                
                const stars = place.rating ? '‚òÖ'.repeat(Math.round(place.rating)) + '‚òÜ'.repeat(5 - Math.round(place.rating)) : '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ';
                const ratingColor = place.rating > 4 ? 'text-amber-400' : 'text-slate-600';

                card.innerHTML = `
                    <div class="absolute top-0 left-0 w-1 h-full ${statusColor}"></div>
                    <div class="pl-3">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg text-white leading-tight pr-2">${place.name}</h3>
                            ${!hasSite ? `<span class="px-2 py-0.5 rounded bg-red-500/20 text-red-400 text-[10px] font-bold border border-red-500/30">${t.target}</span>` : ''}
                        </div>
                        
                        <div class="flex items-center gap-2 mb-3">
                            <span class="${ratingColor} text-sm tracking-widest">${stars}</span>
                            <span class="text-xs text-slate-500 font-mono">(${place.user_ratings_total || 0})</span>
                        </div>

                        <div class="space-y-2 mb-4">
                            <p class="text-xs text-slate-400 flex items-start gap-2">
                                <svg class="w-3 h-3 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                ${place.formatted_address || t.addressNotAvailable}
                            </p>
                            <p class="text-xs text-slate-400 flex items-center gap-2">
                                <svg class="w-3 h-3 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                                ${place.formatted_phone_number || t.phoneNotAvailable}
                            </p>
                        </div>

                        <div class="flex gap-2 pt-3 border-t border-slate-700/50">
                            <a href="${place.url}" target="_blank" class="flex-1 text-center py-1.5 rounded bg-slate-800 hover:bg-slate-700 text-xs text-slate-300 font-medium transition-colors border border-slate-700">
                                ${t.maps}
                            </a>
                            ${hasSite 
                                ? `<a href="${place.website}" target="_blank" class="flex-1 text-center py-1.5 rounded bg-blue-900/30 hover:bg-blue-800/40 text-xs text-blue-300 font-medium transition-colors border border-blue-800/50">${t.visitSite}</a>`
                                : `<span class="flex-1 text-center py-1.5 rounded bg-red-900/10 text-xs text-red-500/50 font-medium border border-red-900/20 cursor-not-allowed">${t.noSite}</span>`
                            }
                        </div>
                    </div>
                `;
                resultsDiv.appendChild(card);
            });
        }


        function exportToCSV(type) {
            const data = type === 'with_site' ? resultsWithWebsite : resultsWithoutWebsite;
            if(!data.length) return;

            const headers = ['Nome', 'Endere√ßo', 'Telefone', 'Rating', 'Reviews', 'Website', 'Maps URL'];
            const csvRows = [headers.join(';')];

            data.forEach(p => {
                const safe = (str) => `"${(str || '').replace(/"/g, '""')}"`;
                csvRows.push([
                    safe(p.name),
                    safe(p.formatted_address),
                    safe(p.formatted_phone_number),
                    p.rating || 0,
                    p.user_ratings_total || 0,
                    safe(p.website),
                    safe(p.url)
                ].join(';'));
            });

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `WIN_ORACLE_${type}_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }

        // Garante que a p√°gina comece em Ingl√™s (ou o idioma definido)
        document.addEventListener('DOMContentLoaded', () => {
            const initialLang = 'en'; // Ingl√™s como padr√£o
            document.getElementById('languageSelector').value = initialLang;
            setLanguage(initialLang);
        });

        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes fadeInUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
